{% extends "base.html" %}

{% block content %}
               <div class="container-fluid">
                   <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                       <h1 class="h2">Grid NF-e</h1>
                       <div class="btn-toolbar mb-2 mb-md-0">
                           <div class="btn-group me-2">
                               <button type="button" class="btn btn-sm btn-outline-secondary" onclick="exportarExcel()">
                                   <i class="fas fa-file-excel"></i> Exportar Excel
                               </button>
                               <button type="button" class="btn btn-sm btn-outline-secondary" onclick="imprimirPDF()">
                                   <i class="fas fa-file-pdf"></i> Imprimir PDF
                               </button>
                           </div>
                       </div>
                   </div>

                   <!-- Filtros -->
                   <div class="card mb-4">
                       <div class="card-header">
                           <h5 class="card-title mb-0">Filtros</h5>
                       </div>
                       <div class="card-body">
                           <div class="row g-3">
                               <div class="col-md-3">
                                   <label class="form-label">Situação</label>
                                   <select class="form-select" id="filtroSituacao">
                                       <option value="Todos">Todos</option>
                                       <option value="Autorizado">Autorizado</option>
                                       <option value="Cancelado">Cancelado</option>
                                       <option value="Denegado">Denegado</option>
                                       <option value="Rejeitado">Rejeitado</option>
                                       <option value="Em Processamento">Em Processamento</option>
                                   </select>
                               </div>
                               <div class="col-md-3">
                                   <label class="form-label">Data Emissão (Início)</label>
                                   <input type="date" class="form-control" id="filtroDataInicio">
                               </div>
                               <div class="col-md-3">
                                   <label class="form-label">Data Emissão (Fim)</label>
                                   <input type="date" class="form-control" id="filtroDataFim">
                               </div>
                               <div class="col-md-3">
                                   <label class="form-label">&nbsp;</label>
                                   <button class="btn btn-primary w-100" onclick="aplicarFiltros()">
                                       <i class="fas fa-filter"></i> Aplicar Filtros
                                   </button>
                               </div>
                           </div>
                       </div>
                   </div>

                   <!-- Grid -->
                   <div class="card">
                       <div class="card-header d-flex justify-content-between align-items-center">
                           <h5 class="card-title mb-0">Notas Fiscais Eletrônicas</h5>
                           <div class="btn-group">
                               <button type="button" class="btn btn-sm btn-success" onclick="acaoLote('enviar_email')">
                                   <i class="fas fa-envelope"></i> Enviar E-mail
                               </button>
                               <button type="button" class="btn btn-sm btn-info" onclick="acaoLote('enviar_erp')">
                                   <i class="fas fa-exchange-alt"></i> Enviar ao ERP
                               </button>
                               <button type="button" class="btn btn-sm btn-primary" onclick="acaoLote('download')">
                                   <i class="fas fa-download"></i> Download XML
                               </button>
                           </div>
                       </div>
                       <div class="card-body">
                           <div class="table-responsive">
                               <table class="table table-striped table-hover">
                                   <thead>
                                       <tr>
                                           <th><input type="checkbox" id="selectAll"></th>
                                           <th>Tipo Emissão</th>
                                           <th>Manifestação</th>
                                           <th>Auditor</th>
                                           <th>Série</th>
                                           <th>Número</th>
                                           <th>Chave de Acesso</th>
                                           <th>Data Emissão</th>
                                           <th>Situação</th>
                                           <th>Emitente</th>
                                           <th>Destinatário</th>
                                           <th>Valor</th>
                                           <th>Ações</th>
                                       </tr>
                                   </thead>
                                   <tbody>
                                       {% for nfe in nfe_list %}
                                       <tr>
                                           <td><input type="checkbox" class="nfe-checkbox" value="{{ nfe.id }}"></td>
                                           <td>
                                               <span class="badge bg-{{ 'success' if nfe.tipo_emissao == 'Normal' else 'warning' }}">
                                                   {{ nfe.tipo_emissao }}
                                               </span>
                                           </td>
                                           <td>
                                               {% if nfe.manifestacao %}
                                               <span class="badge bg-info" title="{{ nfe.manifestacao }}">
                                                   <i class="fas fa-file-alt"></i>
                                               </span>
                                               {% endif %}
                                           </td>
                                           <td>
                                               {% if nfe.auditor %}
                                               <span class="badge bg-{{ 'danger' if nfe.auditor == 'Crítica' else 'warning' if nfe.auditor == 'Sugestão' else 'success' }}">
                                                   <i class="fas fa-search"></i>
                                               </span>
                                               {% endif %}
                                           </td>
                                           <td>{{ nfe.serie }}</td>
                                           <td>{{ nfe.numero }}</td>
                                           <td class="text-nowrap">{{ nfe.chave_acesso }}</td>
                                           <td>{{ nfe.data_emissao }}</td>
                                           <td>
                                               <span class="badge bg-{{
                                                   'success' if nfe.situacao == 'Autorizado'
                                                   else 'danger' if nfe.situacao in ['Cancelado', 'Denegado', 'Rejeitado']
                                                   else 'warning'
                                               }}">
                                                   {{ nfe.situacao }}
                                               </span>
                                           </td>
                                           <td>{{ nfe.emitente }}</td>
                                           <td>{{ nfe.destinatario }}</td>
                                           <td>{{ nfe.valor }}</td>
                                           <td>
                                               <div class="btn-group btn-group-sm">
                                                   <button class="btn btn-outline-primary" title="Download XML"
                                                           onclick="downloadIndividual({{ nfe.id }})">
                                                       <i class="fas fa-download"></i>
                                                   </button>
                                                   <button class="btn btn-outline-secondary" title="Detalhes">
                                                       <i class="fas fa-eye"></i>
                                                   </button>
                                               </div>
                                           </td>
                                       </tr>
                                       {% endfor %}
                                   </tbody>
                               </table>
                           </div>
                       </div>
                   </div>
               </div>

               <!-- Modal de Download -->
               <div class="modal fade" id="modalDownload" tabindex="-1">
                   <div class="modal-dialog">
                       <div class="modal-content">
                           <div class="modal-header">
                               <h5 class="modal-title">Download de XML</h5>
                               <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                           </div>
                           <div class="modal-body" id="modalDownloadBody">
                               <!-- Conteúdo dinâmico -->
                           </div>
                           <div class="modal-footer">
                               <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                           </div>
                       </div>
                   </div>
               </div>
            </div>
        </div>
    </section>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
    // URLs atualizadas para usar o blueprint
    const BASE_URL = '/nfe';

    // Seleção de todos os checkboxes
    document.getElementById('selectAll').addEventListener('change', function() {
        const checkboxes = document.querySelectorAll('.nfe-checkbox');
        checkboxes.forEach(checkbox => {
            checkbox.checked = this.checked;
        });
    });

    function getNfeSelecionadas() {
        const checkboxes = document.querySelectorAll('.nfe-checkbox:checked');
        return Array.from(checkboxes).map(cb => parseInt(cb.value));
    }

    function acaoLote(acao) {
        const ids = getNfeSelecionadas();
        if (ids.length === 0) {
            alert('Selecione pelo menos uma NF-e');
            return;
        }

        if (acao === 'download') {
            downloadXml(ids);
        } else {
            fetch(`${BASE_URL}/api/acoes-lote`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    acao: acao,
                    ids: ids
                })
            })
            .then(response => response.json())
            .then(data => {
                alert(data.message);
            });
        }
    }

    function downloadXml(ids) {
        fetch(`${BASE_URL}/api/download`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ ids: ids })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Criar links para download de cada arquivo
                const modalBody = document.getElementById('modalDownloadBody');
                modalBody.innerHTML = `
                    <p>${data.message}</p>
                    <div class="list-group">
                        ${data.files.map(file => `
                            <a href="${BASE_URL}/download/${file.filename}" class="list-group-item list-group-item-action" download>
                                <i class="fas fa-file-code"></i> ${file.chave_acesso}.xml
                            </a>
                        `).join('')}
                    </div>
                `;
                new bootstrap.Modal(document.getElementById('modalDownload')).show();
            } else {
                alert('Erro ao preparar download: ' + data.message);
            }
        });
    }

    function downloadIndividual(id) {
        downloadXml([id]);
    }

    function aplicarFiltros() {
        const filtros = {
            situacao: document.getElementById('filtroSituacao').value,
            data_inicio: document.getElementById('filtroDataInicio').value,
            data_fim: document.getElementById('filtroDataFim').value
        };

        fetch(`${BASE_URL}/api/filtrar`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(filtros)
        })
        .then(response => response.json())
        .then(data => {
            // Aqui você atualizaria a grid com os dados filtrados
            console.log('Dados filtrados:', data);
            alert('Filtros aplicados (simulação)');
        });
    }

    function exportarExcel() {
        alert('Funcionalidade de exportação para Excel simulada');
    }

    function imprimirPDF() {
        alert('Funcionalidade de impressão PDF simulada');
    }
    </script>
{% endblock %}
